define("FeatureAccess/feature",["tslib","UI/Executor","UI/Base","Types/object","Feature/featureSubscription","Env/Env","EngineUser/Info","Browser/Transport","Browser/Storage","Application/Env","require","exports"],function(n,i,o,a,u,c,f,s,l,p,_,e){Object.defineProperty(e,"__esModule",{value:true}),e["FeatureAccess/_feature/Const"]=true;var v=function(){"use strict";var e={},t=function(e,t){Object.defineProperty(t,"__esModule",{value:true}),t.FEATURE_KEY=t.FEATURE_ACCESS_KEY=t.UNKNOWN_SPECIFICATION=t.FeatureSource=t.FeatureState=t.SpecificationFlags=t.Specification=void 0;var r="0:a:1800";t.UNKNOWN_SPECIFICATION=r;var n="FEATUREACCESS";t.FEATURE_ACCESS_KEY=n;var i="STORE",o,a,u,c,f,s,l,p;t.FEATURE_KEY=i,(a=o||(o={}))["empty"]="a",a["client"]="c",a["user"]="u",a["archive"]="p",t.Specification=o,(c=u||(u={}))[c["r"]=1]="r",c[c["f"]=2]="f",c[c["u"]=4]="u",c[c["a"]=8]="a",c[c["g"]=16]="g",c[c["d"]=32]="d",c[c["v"]=64]="v",t.SpecificationFlags=u,(s=f||(f={}))[s["on"]=1]="on",s[s["off"]=0]="off",s[s["unknown"]=void 0]="unknown",t.FeatureState=f,(p=l||(l={}))[p["local"]=0]="local",p[p["remote"]=1]="remote",p[p["default"]=void 0]="default",t.FeatureSource=l}(_,e);if(t instanceof Function)return t;else if(t&&Object.getPrototypeOf(t)!==Object.prototype)return t;else for(var r in t)if(t.hasOwnProperty(r))e[r]=t[r];return e}();e["FeatureAccess/_feature/Feature"]=true;var h=function(){"use strict";var e={},t=function(e,n){Object.defineProperty(n,"__esModule",{value:true}),n.coefficient=void 0,n.coefficient=1e3;var t=function(){function e(e){var t=this._parseRawData(e),r=t[1];this._state=!!Number(t[0]),this._specification=r,this._cacheLifeTime=Number(t[2])*n.coefficient,this._value=t[3]}return e.prototype.isOn=function(){return this._state},e.prototype.getValue=function(){return this._value},e.prototype.getSpecification=function(){return this._specification},e.prototype.getCacheLifeTime=function(){return this._cacheLifeTime},e.prototype._parseRawData=function(e){var t=e.match(/^\d+:\D+:\d+:/);if(!t)return e.split(":");var r=t[0].split(":"),n=e.substring(t[0].length,e.length);return[r[0],r[1],r[2],n]},e}();n.default=t}(_,e);if(t instanceof Function)return t;else if(t&&Object.getPrototypeOf(t)!==Object.prototype)return t;else for(var r in t)if(t.hasOwnProperty(r))e[r]=t[r];return e}();e["wml!FeatureAccess/_feature/Container/Container"]=true;var S=function(){var e={},t=function(e){function t(){debugger}var d="FeatureAccess/_feature/Container/Container",g=e.TClosure,r=Array.prototype.slice.call(arguments),y={},E={},n,i,o=function e(t,r,n,i,o,a,u){var c=0,f=g.validateNodeKey(r&&r.key),s={id:[],def:void 0},l=g.calcParent(this,void 0,t);if("undefined"===typeof a)a=false;var p=g.createGenerator(i,a,u),_=g.getContext(this),v,h;try{var S=p.joinElements([g.getter(t,["_checkRequiredToggle"]).apply(_,[g.getter(t,["_features"])])?[p.createControlNew("resolver",g.getter(t,["_options","content"]),{},{},{featureValue:g.getter(t,["_features",0,"getValue"]).apply(g.getter(t,["_features",0]),[]),features:g.getter(t,["_features"])},{attr:r,data:t,ctx:this,isVdom:i,defCollection:s,depsLocal:y,includedTemplates:E,viewController:l,context:i?n+"part_"+c++:n,key:f+"0_0_",internal:i?{}:{},mergeType:"attribute",isContainerNode:r&&r.isControlTemplate})]:[p.createTag("invisible-node",{attributes:{},events:{},key:f+"1_0_"},[],r,s,l,r&&r.isControlTemplate)]],f,s);if(s&&s.def)S=p.chain(S,s,this),s=void 0}catch(e){g.templateError(d,e,t)}return S||p.createText("")};return o.stable=true,o.reactiveProps=["_checkRequiredToggle","_features"],o.isWasabyTemplate=true,o}(i);if(t instanceof Function)return t;else if(t&&Object.getPrototypeOf(t)!==Object.prototype)return t;else for(var r in t)if(t.hasOwnProperty(r))e[r]=t[r];return e}();e["FeatureAccess/_feature/Feature2"]=true;var d=function(){"use strict";var e={},t=function(e,i,s,n){Object.defineProperty(i,"__esModule",{value:true}),i.MS_PER_SECONDS=void 0,i.MS_PER_SECONDS=1e3;var t=function(){function e(e,t,r){if(this._name=e,!t||!t.s)return;this._value=t.r.v,this._specification=this._parseSpecification(t.s);var n=this._evalState(t,this._specification,r);if("number"===typeof n)this._state=n;else if("object"===typeof n)if(this._state=n.s,void 0!==n.v)this._value=n.v;this._cacheLifeTime=t.i*i.MS_PER_SECONDS}return e.prototype.isOn=function(){return Boolean(this._state)},e.prototype.getValue=function(){return this._value},e.prototype.getSpecification=function(){return this._specification},e.prototype.getCacheLifeTime=function(){return this._cacheLifeTime},e.prototype.getState=function(){return this._state},e.prototype.getName=function(){return this._name},e.prototype.getUserInfo=function(){var e=n.Info.getSessionValue(),t=e[0],r=e[1];if(t&&r)return{client:t.toString(),user:r.toString()}},e.prototype._parseSpecification=function(e){var t="",r=8,n=16,i=16,o=16;if(e.length!==o)return"";var a=parseInt(e.slice(r,n),i);return Object.keys(s.SpecificationFlags).filter(function(e){return"string"===typeof e}).forEach(function(e){if(s.SpecificationFlags[e]&a)t+=e}),t},e.prototype._evalState=function(e,t,r){var n=t;if(!n.length)return s.FeatureState.off;if(r)return e.r.s;if(n.includes("u")&&e.u){var i;if((i=this.getUserInfo())&&i.user){var o;if(o=this._findState(i.user,e.u))return o}}if(n.includes("a")&&e.a){var i;if((i=this.getUserInfo())&&i.client){var o;if(o=this._findState(i.client,e.a))return o}}if(n.includes("u")||n.includes("a"))return s.FeatureState.unknown;if(n.includes("g"))return s.FeatureState.unknown;if(e.qa){var i;if((i=this.getUserInfo())&&i.client)for(var a=parseInt(i.client,10),u=0,c=e.qa;u<c.length;u++){var f=c[u];if(parseInt(f,16)===a)return s.FeatureState.unknown}}if(n.includes("f")&&e.f)if(e.f.m){var i;if((i=this.getUserInfo())&&i.client&&parseInt(i.client,10)<e.f.m)return s.FeatureState.off;else return s.FeatureState.unknown}else return e.f.s;return e.r.s},e.prototype._findState=function(e,t){for(var r=parseInt(e,10),n=0,i=t;n<i.length;n++)for(var o=i[n],a=0,u=Object.keys(o);a<u.length;a++){var c=u[a],f;if(r===parseInt(c,16))return o[c]}return null},e}();i.default=t}(_,e,v,f);if(t instanceof Function)return t;else if(t&&Object.getPrototypeOf(t)!==Object.prototype)return t;else for(var r in t)if(t.hasOwnProperty(r))e[r]=t[r];return e}();e["FeatureAccess/_feature/Store"]=true;var g=function(){"use strict";var e={},t=function(e,t,o,n,r,a,i,u,c){Object.defineProperty(t,"__esModule",{value:true}),t.Store=t.StorageData=void 0;var f=new r.LocalStorage(u.FEATURE_ACCESS_KEY),s=function(){function e(){this._store={featureStorage:new l},(0,o.getStateReceiver)().register(u.FEATURE_ACCESS_KEY,this._store.featureStorage)}return e.prototype.get=function(e){return this._store.featureStorage.getState()[e]},e.prototype.set=function(e,t){var r=this._store.featureStorage.getState();return r[e]=t,this._store.featureStorage.setState(r),true},e.prototype.getState=function(){return this._store.featureStorage.getState()},e.prototype.remove=function(e){return},e.prototype.getKeys=function(){var t=(0,o.getStore)(u.FEATURE_ACCESS_KEY).getState(),r=[];return Object.keys(t).forEach(function(e){r.push(t[e])}),r},e.prototype.toObject=function(){return(0,o.getStore)(u.FEATURE_ACCESS_KEY).getState()},e}();t.StorageData=s;var l=function(){function e(){this.state={}}return e.prototype.getState=function(){return this.state},e.prototype.setState=function(e){this.state=e},e}(),p=function(){function e(){this.preventServerSubscription=false}return e.prototype._init=function(){if(!((0,o.getStore)(u.FEATURE_ACCESS_KEY)instanceof s))if((0,o.setStore)(u.FEATURE_ACCESS_KEY,new s),a.constants.isBrowserPlatform){var t=(0,o.getStore)(u.FEATURE_ACCESS_KEY).getState(),r=f.getItem(u.FEATURE_KEY)||{};if(Object.keys(t).forEach(function(e){r[e]=t[e]}),f.setItem(u.FEATURE_KEY,r),!this.preventServerSubscription&&i.Subscription)i.Subscription.subscribe(this._onToggleClearCache)}},e.prototype._onToggleClearCache=function(e,t){var r=0,n=-1;if(!t||t.length===r)f.setItem(u.FEATURE_KEY,{});else{var i=f.getItem(u.FEATURE_KEY);Object.keys(i).forEach(function(e){if(e.indexOf(t)!==n)delete i[e]}),f.setItem(u.FEATURE_KEY,i)}},e.prototype._checkValidateCache=function(e){if(!e)return;if("string"===typeof e.rawData){var t,r=(t=new n.default(e.rawData)).getCacheLifeTime();if((new Date).getTime()-new Date(e.timeReceipt).getTime()>r)e.invalidation=t.getSpecification()}else{var t,r=(t=new c.default("",e.rawData)).getCacheLifeTime();if((new Date).getTime()-new Date(e.timeReceipt).getTime()>r)e.invalidation=t.getSpecification()}return e},e.prototype.get=function(e){var t;if(this._init(),!a.constants.isBrowserPlatform)t=(0,o.getStore)(u.FEATURE_ACCESS_KEY).get(e);else{var r=f.getItem(u.FEATURE_KEY);if(t=r&&r[e])return this._checkValidateCache(JSON.parse(t))}if(t)return JSON.parse(t);return},e.prototype.set=function(e,t){this._init();var r={rawData:t,timeReceipt:new Date},n=JSON.stringify(r);if(!a.constants.isBrowserPlatform)(0,o.getStore)(u.FEATURE_ACCESS_KEY).set(e,n);else{var i=f.getItem(u.FEATURE_KEY)||{};i[e]=n,f.setItem(u.FEATURE_KEY,i)}},e}();t.Store=p,t.default=new p}(_,e,p,h,l,c,u,v,d);if(t instanceof Function)return t;else if(t&&Object.getPrototypeOf(t)!==Object.prototype)return t;else for(var r in t)if(t.hasOwnProperty(r))e[r]=t[r];return e}();e["FeatureAccess/_feature/Source"]=true;var y=function(){"use strict";var e={},t=function(e,t,c,f,s,l,r,i){Object.defineProperty(t,"__esModule",{value:true}),t.Source=void 0;var n=function(){function e(e){this._ignoreCache=e}return e.prototype.call=function(t,e,r){var n=this;if(!e||e===l.Specification.empty)return this._loadFeature(t);switch(e){case l.Specification.client:return this._callSpecificationClient(t).then(function(e){if(e.getSpecification()===l.Specification.user)return n._callSpecificationUser(t);return e});case l.Specification.user:return this._callSpecificationUser(t);default:return this._loadFeature(t)}},e.prototype._loadFeature=function(r){var n=this;return this._callWithoutSpecification(r).then(function(e){var t;if(e.getSpecification()!==l.Specification.empty)return n._loadFeatureBySpecification(e,r);return e})},e.prototype._loadFeatureBySpecification=function(e,t){switch(e.getSpecification()){case l.Specification.client:return this._callSpecificationClient(t);case l.Specification.user:return this._callSpecificationUser(t);case l.Specification.archive:return this._showErrorUseArchiveSpecification(t),Promise.resolve(e);default:return Promise.resolve(new f.default(l.UNKNOWN_SPECIFICATION))}},e.prototype._call=function(t,e){var o=this,a="/feature/".concat(e,"/Feature/Get/?"),r=c.__assign(c.__assign({},t),{version:1}),n=[];for(var i in r)if(r.hasOwnProperty(i))n.push("".concat(i,"=").concat(r[i]));if(a+=n.join("&"),!this._ignoreCache){var u=s.default.get(a);if(u&&"string"!==typeof u.invalidation)return Promise.resolve(new f.default(u.rawData))}return this._fetch(a).then(function(e){if(e){var t,r=new f.default(e).getSpecification(),n,i=o._hasAllowedSpecification(r)?e:l.UNKNOWN_SPECIFICATION;return s.default.set(a,i),new f.default(i)}}).catch(function(e){if("HTTP Error"===e.name)throw e;return s.default.set(t.name,l.UNKNOWN_SPECIFICATION),new f.default(l.UNKNOWN_SPECIFICATION)})},e.prototype._fetch=function(n){return new Promise(function(t,r){var e;i.IoC.resolve("ITransport",{method:"GET",dataType:"json",url:n}).execute().addCallback(function(e){return t("string"===typeof e?JSON.parse(e).result:e.result)}).addErrback(function(e){return r(e)})})},e.prototype._callWithoutSpecification=function(e){return this._call({name:e},e)},e.prototype._callSpecificationClient=function(e){var t=this._getUserInfo();if(!t)return Promise.resolve(new f.default(l.UNKNOWN_SPECIFICATION));return this._call({client:t.client,name:e},e)},e.prototype._callSpecificationUser=function(e){var t=this._getUserInfo();if(!t)return Promise.resolve(new f.default(l.UNKNOWN_SPECIFICATION));return this._call({client:t.client,user:t.user,name:e},e)},e.prototype._hasAllowedSpecification=function(e){switch(e){case l.Specification.empty:case l.Specification.client:case l.Specification.user:case l.Specification.archive:return true;default:return false}},e.prototype._showErrorUseArchiveSpecification=function(e){var t=new Error("Проверяемый функционал с идентификатором: ".concat(e," ")+"- перемещен в архив. Удалите из кода все обращения к нему.");i.IoC.resolve("ILogger").error(t)},e.prototype._getUserInfo=function(){var e=r.Info.get("ИдентификаторКлиента"),t=r.Info.get("ИдентификаторПользователя");if(e&&t)return{client:e.toString(),user:t.toString()};else i.IoC.resolve("ILogger").error("Ошибка EngineUser/Info. Не удалось получить id пользователя или клиента")},e}();t.Source=n}(_,e,n,h,g,v,f,c);if(t instanceof Function)return t;else if(t&&Object.getPrototypeOf(t)!==Object.prototype)return t;else for(var r in t)if(t.hasOwnProperty(r))e[r]=t[r];return e}();e["FeatureAccess/_feature/Loader"]=true;var E=function(){"use strict";var e={},t=function(e,t,l,n,p,i,_,v,h,S,c){Object.defineProperty(t,"__esModule",{value:true});var r=function(){function e(){}return e.prototype.require=function(e,t,r){var n=this;if(void 0===r)r=2;var i=[];return e.forEach(function(e){if(2===r)i.push(n._load2(e,t&&v.FeatureSource.remote));else i.push(n._load(e,t))}),Promise.all(i).then(function(e){return e})},e.prototype.requireLocal=function(e){var t=this;return e.map(function(e){return t._loadLocal(e)})},e.prototype.preventServerSubscription=function(){_.default.preventServerSubscription=true},e.prototype._load=function(e,t){if(!t){var r=_.default.get(e);if(r){if("string"===typeof r.invalidation)return(new i.Source).call(e,r.invalidation).then(function(e){return e}).catch(function(e){if("HTTP Error"===e.name)return new n.default(r.rawData);throw e});return Promise.resolve(new n.default(r.rawData))}}return new i.Source(t).call(e).then(function(e){return e}).catch(function(e){if("HTTP Error"===e.name)return new n.default(v.UNKNOWN_SPECIFICATION);throw e})},e.prototype._load2=function(n,i){return l.__awaiter(this,void 0,Promise,function(){var t,r;return l.__generator(this,function(e){switch(e.label){case 0:return[4,this._fetchFeature(n,i)];case 1:if(void 0===(t=e.sent()).getSpecification())return[2,t];if(void 0!==t.getState())return[2,t];if(r=t.getUserInfo())return[2,this._fetchFeature(n,i,r)];return[2,new p.default(n)]}})})},e.prototype._loadLocal=function(e){var t=this._fetchFeature(e,v.FeatureSource.local);if(void 0===t.getSpecification())return t;if(void 0!==t.getState())return t;var r=t.getUserInfo();if(r)return this._fetchFeature(e,v.FeatureSource.local,r);return new p.default(e)},e.prototype._fetchFeature=function(a,e,u){var t=this,r="",n=u||{},i=n.user,o=n.client;if(o)r+="&client=".concat(o);if(i)r+="&user=".concat(i);var c="/feature/".concat(a,"/Feature/Get/?version=2&name=").concat(a).concat(r);if(e!==v.FeatureSource.remote){var f=_.default.get(c);if(f&&f.rawData){var s=void 0;if(e===v.FeatureSource.local||"string"!==typeof f.invalidation)if("object"===typeof f.rawData)s=new p.default(a,f.rawData,u);else s=new p.default(a,JSON.parse(f.rawData),u);if(e===v.FeatureSource.local)return s;if(s)return Promise.resolve(s)}}if(e===v.FeatureSource.local)return new p.default(a);return this._fetch(c,a,u).then(function(o){return l.__awaiter(t,void 0,void 0,function(){var t,r,n,t,i;return l.__generator(this,function(e){switch(e.label){case 0:if(e.trys.push([0,1,,6]),!(t=JSON.parse(o)).s)h.IoC.resolve("ILogger").error("Ошибка FeatureAccess/feature:require ".concat(a,". ")+"Не удалось получить спецификацию из: "+o);return _.default.set(c,t),[2,new p.default(a,t,u)];case 1:if(r=e.sent(),h.IoC.resolve("ILogger").error("Ошибка FeatureAccess/feature:require ".concat(a,". ")+"Не удалось разобрать ответ: "+o),!!S.constants.isBrowserPlatform)return[3,5];e.label=2;case 2:return e.trys.push([2,4,,5]),[4,this._fetch(c,a,u,true)];case 3:return n=e.sent(),t=JSON.parse(n),_.default.set(c,t),[2,new p.default(a,t,u)];case 4:return i=e.sent(),[2,new p.default(a)];case 5:return[2,new p.default(a)];case 6:return[2]}})})})},e.prototype._fetch=function(e,t,r,n){if(void 0===n)n=false;if(n||S.constants.isBrowserPlatform)return h.IoC.resolve("ITransport",{method:"GET",dataType:"json",url:e}).execute().then(function(e){if("string"===typeof e)return h.IoC.resolve("ILogger").warn("Ошибка FeatureAccess/feature:require. "+'Неожиданный тип ответа: "string".\n'+e),JSON.parse(e).result;return e.result});else{var i="user",o,a={version:2,name:t};if(r)a["account"]=r.client,a[i]=r.user;var u=2;return new c.RPCJSON({serviceUrl:S.constants.appRoot}).callMethod("JSFeature.Get",a,false,u).then(function(e){return e}).catch(function(e){return h.IoC.resolve("ILogger").warn("Ошибка FeatureAccess/feature:require ".concat(t,". ")+"RPCJSON: "+e.message),"{}"})}},e}();t.default=new r}(_,e,n,h,d,y,g,v,c,c,s);if(t instanceof Function)return t;else if(t&&Object.getPrototypeOf(t)!==Object.prototype)return t;else for(var r in t)if(t.hasOwnProperty(r))e[r]=t[r];return e}(),t=E;e["FeatureAccess/_feature/Container"]=true;var r,F=function(){"use strict";var e={},t=function(e,t,r,n,i,o,a){Object.defineProperty(t,"__esModule",{value:true});var u=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e._template=a,e}return r.__extends(e,t),e.prototype._beforeMount=function(e){var r=this,t=i.default.requireLocal(e.idFeature);this._idFeature=e.idFeature,this._features=t,i.default.require(e.idFeature).then(function(e){var t;if(e.some(function(e,t){return e.isOn()!==r._features[t].isOn()}))r._features=e})},e.prototype._beforeUpdate=function(t){var r=this;if(!this._features||!(0,o.isEqual)(this._idFeature,t.idFeature))i.default.require(t.idFeature).then(function(e){r._idFeature=t.idFeature,r._features=e})},e.prototype._checkRequiredToggle=function(e){if("Any"===this._options.requiredToggle)return true;var t="Off"===this._options.requiredToggle?false:true;return e.every(function(e){return e.isOn()===t})},e.defaultProps={requiredToggle:"On"},e}(n.Control);t.default=u}(_,e,n,o,E,a,S);if(t instanceof Function)return t;else if(t&&Object.getPrototypeOf(t)!==Object.prototype)return t;else for(var r in t)if(t.hasOwnProperty(r))e[r]=t[r];return e}();return e.Container=e.Feature=void 0,e.Feature=t.default,e.Container=F.default,e});